## **索引本质**

索引（Index）是帮助MySQL高效获取数据的数据结构。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。

## **局部性原理、磁盘预读**

* **局部性原理**

当一个数据被用到时，其附近的数据也通常会马上被使用，程序运行期间所需要的数据通常比较集中。

* **磁盘预读**

由于存储介质的特性，磁盘本身存取比主存慢很多，为了提高效率，要尽量减少磁盘I/O。为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。预读的长度一般为页（page）的整倍数。页是计算机管理存储器的逻辑块，硬件及操作系统往往将主存和磁盘存储区分割为连续的大小相等的块，每个存储块称为一页（在许多操作系统中，页得大小通常为4k），主存和磁盘以页为单位交换数据。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。

## **B树、B+树实现MySQL索引**

一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上，索引查找过程中就要产生磁盘I/O消耗，相对于内存存取，I/O存取的消耗要高几个数量级，所以评价一个数据结构作为索引的优劣最重要的指标就是在查找过程中磁盘I/O操作次数的渐进复杂度。换句话说，索引的结构组织要尽量减少查找过程中磁盘I/O的存取次数。

根据B-Tree的定义，可知检索一次最多需要访问h-1（树高度）个节点。数据库系统的设计者巧妙利用了磁盘预读原理，将一个节点的大小设为等于一个页，这样每个节点只需要一次I/O就可以完全载入。每次新建节点时，直接申请一个页的空间，这样就保证一个节点物理上也存储在一个页里，加之计算机存储分配都是按页对齐的，就实现了一个node只需一次I/O。

## **B+树**

> *见[链接](http://blog.jobbole.com/86594/)*

## **MySQL索引实现**

* **MyISAM索引实现**

MyISAM引擎使用B+Tree作为索引结构，叶节点的data域存放的是数据记录的地址。MyISAM中索引检索的算法为首先按照B+Tree搜索算法搜索索引，如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录。MyISAM的索引方式是“非聚集”的。

![MyISAM主索引原理图](http://upload-images.jianshu.io/upload_images/7109298-6c942aae84e2a771.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

* **InnoDB索引实现**

InnoDB也使用B+Tree作为索引结构，但具体实现方式却与MyISAM截然不同。**第一个重大区别是InnoDB的数据文件本身就是索引文件。MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而InnoDB中表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引**。这种索引叫做聚集索引。因为InnoDB的数据文件本身要按主键聚集，所以InnoDB要求表必须有主键（MyISAM可以没有），如果没有显式指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键。


![InnoDB主索引原理图](http://upload-images.jianshu.io/upload_images/7109298-f36264128147d7b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

第二个与MyISAM索引的不同是InnoDB的辅助索引data域存储相应记录主键的值而不是地址。换句话说，InnoDB的所有辅助索引都引用主键作为data域。


![InnoDB辅助索引原理图](http://upload-images.jianshu.io/upload_images/7109298-01419f1da724c0f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

聚集索引这种实现方式使得按主键的搜索十分高效，但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。

## **建立索引**

1. 建索引的几项原则，见链接[建索引的几大原则](http://blog.jobbole.com/86594/)。总结起来就是以下几点：

* 最左前缀匹配原则
> *MySQL会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配*
* =和in可以乱序
* 尽量选择区分度高的列作为索引
> *查询中很少使用到的列，或者只有很少数据值的列不该作为索引，不但不能加快检索速度，反而增加了维护难度、增加了空间需求*
* 索引列不能参与计算
* 尽量的扩展索引，不要新建索引

2. [InnoDB的主键选择与插入优化](http://blog.jobbole.com/24006/)，主要是以下两点：

* 不要使用过长的字段作为主键，较短的数据类型可以减少索引的磁盘空间占用，而且过长的主索引会让辅助索引变得过大
* 使用自增字段作为主键，可以保证主键的唯一性
> *InnoDB数据文件本身是B+树，使用递增的主键，新纪录会顺序插入到当前索引节点的后续位置，当一页写满后悔自动开辟新页，形成紧凑的数据结构，效率很高；如果使用非自增主键，由于每次插入主键的值近似于随机，因此每次新纪录都要被插到现有索引页的中间某个位置，不得不频繁移动数据或者分页，增加了开销并造成大量的表碎片*
